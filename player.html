<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ†Ø² Ù…Ø¹ Ø´Ù‡Ø¯ğŸ´â€â˜ ï¸ğŸ</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap&subset=arabic" rel="stylesheet">
<style>
body{
  font-family:"Baloo 2", cursive;
  background: linear-gradient(120deg, #d0e7ff, #f0f8ff);
  color: #2c4a6e;
  padding:15px;
  text-align:center;
  overflow-y: scroll;
  transition: all 0.5s ease;
}
h1,h2{color:#2c4a6e;}
select,button,input{width:90%;max-width:320px;padding:10px;margin:8px auto;border-radius:12px;border:none;font-size:16px;}
button{
  background: #4a90e2;
  color:white;
  cursor:pointer;
  border-radius:12px;
  padding:10px 20px;
  font-size:16px;
  transition: transform 0.2s, box-shadow 0.3s;
}
button:hover{
  transform: scale(1.05);
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  background: #357ABD;
}
.optionBtn{
  display:block;
  margin:10px auto;
  padding:10px;
  background:#6fa8dc;
  color:white;
  border-radius:8px;
  transition:0.2s;
}
.optionBtn:hover{
  background:#5596c3;
  transform:scale(1.05);
}
#waitingScreen,#countdownScreen,#gameArea{display:none;margin-top:20px;}
#countdown{font-size:60px;color:#357ABD;margin-top:40px;}
#hintText{margin-top:10px;font-weight:bold;color:#006400;}
#progressDisplay{margin-top:10px;font-weight:bold;color:#2c4a6e; background: linear-gradient(90deg, #4a90e2, #50b3d6); padding:8px; border-radius:10px;}
#codeContainer{display:none;margin-top:10px;}
#endMessage{font-size:1.2em;color:#2c4a6e;margin-top:20px;}
#gameArea{animation: fadeIn 0.8s ease;}
@keyframes fadeIn{
  0%{opacity:0; transform: translateY(20px);}
  100%{opacity:1; transform: translateY(0);}
}
</style>
<!-- Firebase SDKs -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAcJKk9kmCdWOegFIv2EPnPKpUlxu6qgQM",
  authDomain: "shahadgame-4dcb5.firebaseapp.com",
  projectId: "shahadgame-4dcb5",
  storageBucket: "shahadgame-4dcb5.appspot.com",
  messagingSenderId: "1053224905668",
  appId: "1:1053224905668:web:a37923d2f1f50bb6ba5291"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† LocalStorage
let stages = JSON.parse(localStorage.getItem("stages")) || [];
let teams = JSON.parse(localStorage.getItem("teams")) || [];
let playerTeam = localStorage.getItem("playerTeam") || "";
let currentStage = parseInt(localStorage.getItem("stage-" + playerTeam)) || 0;
let startTime = parseInt(localStorage.getItem("startTime")) || Date.now();
let timerInterval = null;

// Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
const teamSelect = document.getElementById("teamSelect");
const waitingScreen = document.getElementById("waitingScreen");
const countdownScreen = document.getElementById("countdownScreen");
const countdownElem = document.getElementById("countdown");
const gameArea = document.getElementById("gameArea");
const codeContainer = document.getElementById("codeContainer");
const progressDisplay = document.getElementById("progressDisplay");

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ±Ù‚ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
teams.forEach(team => {
  const opt = document.createElement("option");
  opt.value = team;
  opt.textContent = team;
  teamSelect.appendChild(opt);
});

// Ù„Ùˆ Ø§Ù„ÙØ±ÙŠÙ‚ Ù…Ø­ÙÙˆØ¸ Ù…Ø³Ø¨Ù‚Ø§Ù‹
if(playerTeam){
  teamSelect.parentElement.style.display = "none";
  document.getElementById("playerTeamName").textContent = playerTeam;
  if(!gameStarted()) waitingScreen.style.display="block";
  else startCountdown();
}

// ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
function gameStarted() {
  return localStorage.getItem("gameStarted")==="yes" && localStorage.getItem("startTime");
}

// Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚
teamSelect.addEventListener("change",()=>{
  if(!teamSelect.value) return;
  playerTeam = teamSelect.value;
  localStorage.setItem("playerTeam",playerTeam);
  document.getElementById("playerTeamName").textContent = playerTeam;
  currentStage = parseInt(localStorage.getItem("stage-" + playerTeam)) || 0;
  teamSelect.parentElement.style.display = "none";
  waitingScreen.style.display = "block";
});

// Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
if(playerTeam){
  const teamProgressRef = ref(db, `gameProgress/${playerTeam}`);
  onValue(teamProgressRef, snap=>{
    const progress = snap.val() || { stage:0, time:0 };
    progressDisplay.textContent = `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${progress.stage} | Ø§Ù„ÙˆÙ‚Øª ${Math.floor(progress.time/60)}:${progress.time%60 < 10 ? '0'+progress.time%60 : progress.time%60}`;
  });
}

// ØªØ­Ù‚Ù‚ ÙƒÙ„ Ù†ØµÙ Ø«Ø§Ù†ÙŠØ© Ø¥Ø°Ø§ Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø§Ø³ØªØ± Ø§Ù„Ù„Ø¹Ø¨Ø©
setInterval(()=>{
  if(playerTeam && gameStarted() && !timerInterval){
    waitingScreen.style.display="none";startCountdown();
  }
},500);

function startCountdown(){
  countdownScreen.style.display="block";
  let count=3;
  countdownElem.textContent=count;
  const interval=setInterval(()=>{
    count--;
    if(count===0){
      clearInterval(interval);
      countdownScreen.style.display="none";
      startGame();
    } else countdownElem.textContent=count;
  },1000);
}

function startGame(){
  gameArea.style.display="block";
  startTime = parseInt(localStorage.getItem("startTime")) || Date.now();
  timerInterval=setInterval(()=>{
    const sec=Math.floor((Date.now()-startTime)/1000);
    progressDisplay.textContent = `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${currentStage} | Ø§Ù„ÙˆÙ‚Øª ${Math.floor(sec/60)}:${sec%60 < 10 ? '0'+sec%60 : sec%60}`;
    const teamProgressRef = ref(db, `gameProgress/${playerTeam}`);
    set(teamProgressRef, { stage: currentStage, time: sec });
  },1000);
  showStage();
}

function showStage() {
  if(currentStage >= stages.length) { 
    document.getElementById("questionText").textContent = "ğŸ¯ Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ  ğŸğŸğŸŠğŸ‰Ù„Ù…ÙƒØ§Ù† Ø§Ù„ÙƒÙ†Ø²: " + stages[stages.length-1].hints.easy;
    document.getElementById("optionsContainer").innerHTML = "";
    codeContainer.style.display = "none";
    document.getElementById("hintText").textContent = "";
    return;
  }
  const stage = stages[currentStage];
  document.getElementById("questionText").textContent = stage.question;
  document.getElementById("hintText").textContent = "";
  codeContainer.style.display = "none";
  document.getElementById("codeInput").value = "";

  const cont = document.getElementById("optionsContainer");
  cont.innerHTML = "";
  stage.options.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.className = "optionBtn";
    btn.textContent = opt;
    btn.onclick = () => {
      document.getElementById("hintText").textContent =
        (i+1 === stage.answer ? "âœ”ï¸ " + stage.hints.easy : "âŒ " + stage.hints.hard);
      codeContainer.style.display = "block";
    };
    cont.appendChild(btn);
  });
}

document.getElementById("checkCodeBtn").onclick=()=>{
  const stage=stages[currentStage];
  const codeInput=document.getElementById("codeInput").value.trim();
  if(codeInput===stage.codes[playerTeam]){
    currentStage++;
    const teamProgressRef = ref(db, `gameProgress/${playerTeam}`);
    const sec=Math.floor((Date.now()-startTime)/1000);
    set(teamProgressRef, { stage: currentStage, time: sec });
    localStorage.setItem("stage-"+playerTeam,currentStage);
    showStage();
  } else alert("Ø§Ù„ÙƒÙˆØ¯ Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©!");
};
</script>
</head>
<body>
<h1> Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ†Ø² Ù…Ø¹ Ø´Ù‡Ø¯</h1>
<div id="teamSelection">
  <h2>Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</h2>
  <select id="teamSelect">
    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙØ±ÙŠÙ‚ --</option>
  </select>
</div>
<div id="waitingScreen">â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø´ÙŠØ®Ø©  ğŸ‘¸ğŸ»Ø§Ù„Ø´ÙŠØ®Ø§Øª  ØªØ¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©...</div>
<div id="countdownScreen">
  <div id="countdown">3</div>
</div>
<div id="gameArea">
  <div>Ø§Ù„ÙØ±ÙŠÙ‚: <span id="playerTeamName"></span></div>
  <h2 id="questionText"></h2>
  <div id="optionsContainer"></div>
  <div id="hintText"></div>
  <div id="codeContainer">
    <input type="text" id="codeInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ÙˆØ±Ù‚Ù‡ ğŸ§">
    <button id="checkCodeBtn">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯</button>
  </div>
  <div id="progressDisplay">Ø§Ù„Ù…Ø±Ø­Ù„Ø© 0 | Ø§Ù„ÙˆÙ‚Øª 0:00</div>
</div>
</body>
</html>
