<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ†Ø² Ù…Ø¹ Ø´Ù‡Ø¯</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap&subset=arabic" rel="stylesheet">
<style>
body { font-family:"Baloo 2", cursive; background:#e0f7ff; text-align:center; padding:10px;}
h1,h2{color:#2c4a6e;}
select,button,input{width:90%;max-width:320px;padding:10px;margin:8px auto;border-radius:10px;border:none;font-size:16px;}
button{background:#4a90e2;color:white;cursor:pointer;transition:0.2s;}
button:hover{transform:scale(1.05);background:#357ABD;}
.optionBtn{display:block;margin:10px auto;padding:10px;background:#6fa8dc;color:white;border-radius:8px;transition:0.2s;}
.optionBtn:hover{background:#5596c3;transform:scale(1.05);}
#waitingScreen,#countdownScreen,#gameArea{display:none;margin-top:20px;}
#countdown{font-size:60px;color:#357ABD;margin-top:40px;}
#hintText{margin-top:10px;font-weight:bold;color:#006400;}
#progressDisplay{margin-top:10px;font-weight:bold;color:#2c4a6e;}
#codeContainer{display:none;margin-top:10px;}
#endMessage{font-size:1.2em;color:#2c4a6e;margin-top:20px;}
</style>
</head>
<body>

<h1>Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ†Ø² Ù…Ø¹ Ø´Ù‡Ø¯</h1>

<div id="teamSelection">
  <h2>Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</h2>
  <select id="teamSelect">
    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙØ±ÙŠÙ‚ --</option>
  </select>
</div>

<div id="waitingScreen">â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨...</div>

<div id="countdownScreen">
  <div id="countdown">3</div>
</div>

<div id="gameArea">
  <div>Ø§Ù„ÙØ±ÙŠÙ‚: <span id="playerTeamName"></span> | Ø§Ù„ÙˆÙ‚Øª: <span id="timeDisplay">0:00</span></div>
  <h2 id="questionText"></h2>
  <div id="optionsContainer"></div>
  <div id="hintText"></div>
  <div id="codeContainer">
    <input type="text" id="codeInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯">
    <button id="checkCodeBtn">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯</button>
  </div>
  <div id="progressDisplay"></div>
</div>

<audio id="startSound"><source src="start.mp3" type="audio/mpeg"></audio>
<audio id="correctSound"><source src="correct.mp3" type="audio/mpeg"></audio>
<audio id="wrongSound"><source src="wrong.mp3" type="audio/mpeg"></audio>
<audio id="winSound"><source src="win.mp3" type="audio/mpeg"></audio>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAcJKk9kmCdWOegFIv2EPnPKpUlxu6qgQM",
    authDomain: "shahadgame-4dcb5.firebaseapp.com",
    databaseURL: "https://shahadgame-4dcb5-default-rtdb.firebaseio.com/",
    projectId: "shahadgame-4dcb5",
    storageBucket: "shahadgame-4dcb5.appspot.com",
    messagingSenderId: "1053224905668",
    appId: "1:1053224905668:web:a37923d2f1f50bb6ba5291"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let stages = JSON.parse(localStorage.getItem("stages")) || [];
  let teams = JSON.parse(localStorage.getItem("teams")) || [];
  let playerTeam = localStorage.getItem("playerTeam") || "";
  let currentStage = parseInt(localStorage.getItem("stage-" + playerTeam)) || 0;
  let timerInterval = null;

  const teamSelect = document.getElementById("teamSelect");
  const waitingScreen = document.getElementById("waitingScreen");
  const countdownScreen = document.getElementById("countdownScreen");
  const countdownElem = document.getElementById("countdown");
  const gameArea = document.getElementById("gameArea");
  const codeContainer = document.getElementById("codeContainer");

  teams.forEach(team => {
    const opt = document.createElement("option");
    opt.value = team;
    opt.textContent = team;
    teamSelect.appendChild(opt);

    // Ø§Ø³ØªÙ…Ø§Ø¹ Firebase Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
    const teamRef = ref(db, 'teams/' + team);
    onValue(teamRef, snapshot => {
      const data = snapshot.val();
      if(data && playerTeam === team && timerInterval){
        localStorage.setItem("stage-"+team, data.stage);
        localStorage.setItem("time-"+team, data.time);
        document.getElementById("timeDisplay").textContent =
          Math.floor(data.time/60)+":"+(data.time%60<10?"0"+data.time%60:data.time%60);
        document.getElementById("progressDisplay").textContent="Ø§Ù„Ù…Ø±Ø­Ù„Ø© "+data.stage;
      }
    });
  });

  // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚
  teamSelect.addEventListener("change",()=>{
    if(!teamSelect.value) return;
    playerTeam = teamSelect.value;
    localStorage.setItem("playerTeam",playerTeam);
    document.getElementById("playerTeamName").textContent = playerTeam;
    currentStage = parseInt(localStorage.getItem("stage-" + playerTeam)) || 0;
    teamSelect.parentElement.style.display = "none";
    waitingScreen.style.display = "block";
  });

  function gameStarted() {
    return localStorage.getItem("gameStarted") === "yes" && localStorage.getItem("startTime") !== null;
  }

  setInterval(()=>{
    if(playerTeam && gameStarted() && !timerInterval){
      waitingScreen.style.display = "none";
      startCountdown();
    }
  },500);

  function startCountdown(){
    countdownScreen.style.display = "block";
    let count=3;
    countdownElem.textContent=count;
    const interval=setInterval(()=>{
      count--;
      if(count===0){
        clearInterval(interval);
        countdownScreen.style.display="none";
        document.getElementById("startSound").play();
        startGame();
      } else countdownElem.textContent=count;
    },1000);
  }

  function startGame(){
    gameArea.style.display="block";
    const startTime=parseInt(localStorage.getItem("startTime"));
    timerInterval=setInterval(()=>{
      const sec=Math.floor((Date.now()-startTime)/1000);
      document.getElementById("timeDisplay").textContent=
        Math.floor(sec/60)+":"+(sec%60<10?"0"+sec:sec%60);
      localStorage.setItem("time-"+playerTeam,sec);
      document.getElementById("progressDisplay").textContent="Ø§Ù„Ù…Ø±Ø­Ù„Ø© "+currentStage;
    },1000);
    showStage();
  }

  function showStage() {
    if(currentStage >= stages.length) { 
      document.getElementById("questionText").textContent="ğŸ‰ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!"; 
      codeContainer.style.display="none";
      document.getElementById("winSound").play();
      return;
    }
    const stage=stages[currentStage];
    document.getElementById("questionText").textContent=stage.question;
    codeContainer.style.display="block";
    document.getElementById("codeInput").value="";
  }

  document.getElementById("checkCodeBtn").addEventListener("click",()=>{
    const codeInput=document.getElementById("codeInput").value.trim();
    const stage=stages[currentStage];
    if(codeInput === stage.codes[playerTeam]){
      currentStage++;
      const now = Math.floor((Date.now() - parseInt(localStorage.getItem("startTime")))/1000);
      localStorage.setItem("stage-"+playerTeam,currentStage);
      localStorage.setItem("time-"+playerTeam,now);
      set(ref(db,'teams/'+playerTeam),{stage:currentStage,time:now});
      document.getElementById("correctSound").play();
      showStage();
    } else {
      document.getElementById("wrongSound").play();
      alert("Ø§Ù„ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦!");
    }
  });
</script>

</body>
</html>
