<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ†Ø² Ù…Ø¹ Ø´Ù‡Ø¯ - Ø§Ù„Ù„Ø§Ø¹Ø¨</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap&subset=arabic" rel="stylesheet">
<style>
body { font-family:"Baloo 2", cursive; background:#e0f0ff; text-align:center; padding:10px;}
h1,h2{color:#2c4a6e;}
select,button,input{width:90%;max-width:320px;padding:10px;margin:8px auto;border-radius:10px;border:none;font-size:16px;}
button{background:#4a90e2;color:white;cursor:pointer;transition:0.2s; font-weight:bold;}
button:hover{transform:scale(1.05); background:#357ABD;}
.optionBtn{display:block;margin:10px auto;padding:10px;background:#6fa8dc;color:white;border-radius:8px;transition:0.2s;}
.optionBtn:hover{background:#5596c3;transform:scale(1.05);}
#waitingScreen,#countdownScreen,#gameArea{display:none;margin-top:20px;}
#countdown{font-size:60px;color:#357ABD;margin-top:40px;}
#hintText{margin-top:10px;font-weight:bold;color:#006400;}
#progressDisplay{margin-top:10px;font-weight:bold;color:#2c4a6e;}
#codeContainer{display:none;margin-top:10px;}
#endMessage{font-size:1.2em;color:#2c4a6e;margin-top:20px;}
</style>
</head>
<body>

<h1>Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ†Ø² Ù…Ø¹ Ø´Ù‡Ø¯</h1>

<div id="teamSelection">
  <h2>Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</h2>
  <select id="teamSelect">
    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙØ±ÙŠÙ‚ --</option>
  </select>
</div>

<div id="waitingScreen">â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨...</div>
<div id="countdownScreen">
  <div id="countdown">3</div>
</div>

<div id="gameArea">
  <div>Ø§Ù„ÙØ±ÙŠÙ‚: <span id="playerTeamName"></span> | Ø§Ù„ÙˆÙ‚Øª: <span id="timeDisplay">0:00</span></div>
  <h2 id="questionText"></h2>
  <div id="optionsContainer"></div>
  <div id="hintText"></div>
  <div id="codeContainer">
    <input type="text" id="codeInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯">
    <button id="checkCodeBtn">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯</button>
  </div>
  <div id="progressDisplay"></div>
</div>

<audio id="startSound"><source src="start.mp3" type="audio/mpeg"></audio>
<audio id="correctSound"><source src="correct.mp3" type="audio/mpeg"></audio>
<audio id="wrongSound"><source src="wrong.mp3" type="audio/mpeg"></audio>
<audio id="winSound"><source src="win.mp3" type="audio/mpeg"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, onValue, get, child, update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAcJKk9kmCdWOegFIv2EPnPKpUlxu6qgQM",
  authDomain: "shahadgame-4dcb5.firebaseapp.com",
  databaseURL: "https://shahadgame-4dcb5-default-rtdb.firebaseio.com",
  projectId: "shahadgame-4dcb5",
  storageBucket: "shahadgame-4dcb5.appspot.com",
  messagingSenderId: "1053224905668",
  appId: "1:1053224905668:web:a37923d2f1f50bb6ba5291"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Elements
const teamSelect = document.getElementById("teamSelect");
const waitingScreen = document.getElementById("waitingScreen");
const countdownScreen = document.getElementById("countdownScreen");
const countdownElem = document.getElementById("countdown");
const gameArea = document.getElementById("gameArea");
const codeContainer = document.getElementById("codeContainer");
const playerTeamNameElem = document.getElementById("playerTeamName");
const optionsContainer = document.getElementById("optionsContainer");
const questionText = document.getElementById("questionText");
const hintText = document.getElementById("hintText");
const timeDisplay = document.getElementById("timeDisplay");
const progressDisplay = document.getElementById("progressDisplay");
const codeInput = document.getElementById("codeInput");
const checkCodeBtn = document.getElementById("checkCodeBtn");

let playerTeam = localStorage.getItem("playerTeam")||"";
let currentStage=0;
let stages=[];
let timerInterval=null;

// Load teams & stages
get(ref(db,"game")).then(snapshot=>{
  const data=snapshot.val();
  if(!data) return;
  stages = data.stages||[];
  const teams = data.teams||[];
  teams.forEach(t=>{
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    teamSelect.appendChild(opt);
  });
  if(playerTeam) selectTeam(playerTeam);
});

// Select team
function selectTeam(team){
  playerTeam=team;
  localStorage.setItem("playerTeam",team);
  playerTeamNameElem.textContent=team;
  teamSelect.parentElement.style.display="none";

  // Load player progress
  get(ref(db,"players/"+team)).then(snap=>{
    const data=snap.val();
    currentStage=data.currentStage||0;
  });

  checkStart();
}
teamSelect.addEventListener("change",()=>{if(teamSelect.value) selectTeam(teamSelect.value);});

// Realtime check for start
function checkStart(){
  onValue(ref(db,"game"),snapshot=>{
    const game = snapshot.val();
    if(game.gameStarted){
      waitingScreen.style.display="none";
      startCountdown();
    } else if(playerTeam){
      waitingScreen.style.display="block";
    }
  });
}

// Countdown
function startCountdown(){
  countdownScreen.style.display="block";
  let count=3;
  countdownElem.textContent=count;
  const interval=setInterval(()=>{count--; 
    if(count===0){clearInterval(interval); countdownScreen.style.display="none"; startGame();} 
    else countdownElem.textContent=count;
  },1000);
}

// Start game
function startGame(){
  gameArea.style.display="block";
  timerInterval=setInterval(()=>{
    get(ref(db,"players/"+playerTeam)).then(snap=>{
      const data=snap.val();
      const sec=data.time||0;
      timeDisplay.textContent=Math.floor(sec/60)+":"+(sec%60<10?"0"+sec:sec%60);
      progressDisplay.textContent="Ø§Ù„Ù…Ø±Ø­Ù„Ø© "+(data.currentStage||0);
    });
  },1000);
  showStage();
}

// Show stage
function showStage(){
  if(currentStage>=stages.length){
    questionText.textContent="ğŸ¯ Ø§Ù„ÙƒÙ†Ø² ÙˆØµÙ„!";
    optionsContainer.innerHTML="";
    codeContainer.style.display="none";
    hintText.textContent="";
    return;
  }
  const stage = stages[currentStage];
  questionText.textContent = stage.question;
  hintText.textContent="";
  codeContainer.style.display="none";
  optionsContainer.innerHTML="";
  stage.options.forEach((opt,i)=>{
    const btn = document.createElement("button");
    btn.className="optionBtn";
    btn.textContent=opt;
    btn.onclick=()=>{
      hintText.textContent=(i+1===stage.answer?"âœ”ï¸ "+stage.hints.easy:"âŒ "+stage.hints.hard);
      codeContainer.style.display="block";
      if(i+1===stage.answer) document.getElementById("correctSound").play();
      else document.getElementById("wrongSound").play();
    };
    optionsContainer.appendChild(btn);
  });
}

// Check code
checkCodeBtn.onclick=()=>{
  const stage=stages[currentStage];
  if(codeInput.value.trim()===stage.codes[playerTeam]){
    currentStage++;
    update(ref(db,"players/"+playerTeam),{currentStage:currentStage});
    showStage();
    if(currentStage>=stages.length) document.getElementById("winSound").play();
  } else alert("Ø§Ù„ÙƒÙˆØ¯ Ø®Ø·Ø£ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©!");
};
</script>
</body>
</html>
