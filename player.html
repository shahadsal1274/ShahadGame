<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ†Ø² Ù…Ø¹ Ø´Ù‡Ø¯ - Player</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap&subset=arabic" rel="stylesheet">
<style>
body{font-family:"Baloo 2", cursive;background:#e0f0ff;text-align:center;padding:10px;}
h1,h2{color:#2c4a6e;}
select,button,input{width:90%;max-width:320px;padding:10px;margin:8px auto;border-radius:10px;border:none;font-size:16px;}
button{background:#4a90e2;color:white;cursor:pointer;transition:0.2s;}
button:hover{transform:scale(1.05);}
.optionBtn{display:block;margin:10px auto;padding:10px;background:#6fa8dc;color:white;border-radius:8px;transition:0.2s;}
.optionBtn:hover{background:#5596c3;transform:scale(1.05);}
#waitingScreen,#countdownScreen,#gameArea{display:none;margin-top:20px;}
#countdown{font-size:60px;color:#357ABD;margin-top:40px;}
#hintText{margin-top:10px;font-weight:bold;color:#006400;}
#progressDisplay{margin-top:10px;font-weight:bold;color:#2c4a6e;}
#codeContainer{display:none;margin-top:10px;}
#endMessage{font-size:1.2em;color:#2c4a6e;margin-top:20px;}
</style>
</head>
<body>

<h1>Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ†Ø² Ù…Ø¹ Ø´Ù‡Ø¯</h1>

<div id="teamSelection">
  <h2>Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</h2>
  <select id="teamSelect">
    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙØ±ÙŠÙ‚ --</option>
  </select>
</div>

<div id="waitingScreen">â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨...</div>
<div id="countdownScreen"><div id="countdown">3</div></div>

<div id="gameArea">
  <div>Ø§Ù„ÙØ±ÙŠÙ‚: <span id="playerTeamName"></span> | Ø§Ù„ÙˆÙ‚Øª: <span id="timeDisplay">0:00</span></div>
  <h2 id="questionText"></h2>
  <div id="optionsContainer"></div>
  <div id="hintText"></div>
  <div id="codeContainer">
    <input type="text" id="codeInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯">
    <button id="checkCodeBtn">ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯</button>
  </div>
  <div id="progressDisplay"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAcJKk9kmCdWOegFIv2EPnPKpUlxu6qQM",
  authDomain: "shahadgame-4dcb5.firebaseapp.com",
  databaseURL: "https://shahadgame-4dcb5-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "shahadgame-4dcb5",
  storageBucket: "shahadgame-4dcb5.appspot.com",
  messagingSenderId: "1053224905668",
  appId: "1:1053224905668:web:a37923d2f1f50bb6ba5291"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const teamSelect = document.getElementById("teamSelect");
const waitingScreen = document.getElementById("waitingScreen");
const countdownScreen = document.getElementById("countdownScreen");
const countdownElem = document.getElementById("countdown");
const gameArea = document.getElementById("gameArea");
const codeContainer = document.getElementById("codeContainer");

let playerTeam = localStorage.getItem("playerTeam") || "";
let stages=[], teams=[], currentStage=0;
let timerInterval=null;

// Fetch game data
onValue(ref(db, 'gameData'), snapshot => {
  const data = snapshot.val();
  if(!data) return;
  teams = data.teams;
  stages = data.stages;

  // Populate team select
  if(teamSelect.options.length<=1){
    teams.forEach(team => {
      const opt = document.createElement("option");
      opt.value = team;
      opt.textContent = team;
      teamSelect.appendChild(opt);
    });
  }

  // If player already selected team
  if(playerTeam){
    teamSelect.parentElement.style.display="none";
    document.getElementById("playerTeamName").textContent = playerTeam;
    currentStage = data.teams.indexOf(playerTeam)>=0 ? 0 : 0;
    if(data.gameStarted) startCountdown();
    else waitingScreen.style.display="block";
  }

  // Listen for game start
  if(data.gameStarted && !timerInterval){
    waitingScreen.style.display="none";
    startCountdown();
  }
});

// Choose team
teamSelect.addEventListener("change",()=>{
  if(!teamSelect.value) return;
  playerTeam = teamSelect.value;
  localStorage.setItem("playerTeam",playerTeam);
  document.getElementById("playerTeamName").textContent = playerTeam;
  teamSelect.parentElement.style.display="none";
  waitingScreen.style.display="block";
});

function startCountdown(){
  countdownScreen.style.display="block";
  let count=3;
  countdownElem.textContent=count;
  const interval=setInterval(()=>{
    count--;
    if(count===0){
      clearInterval(interval);
      countdownScreen.style.display="none";
      startGame();
    } else countdownElem.textContent=count;
  },1000);
}

function startGame(){
  gameArea.style.display="block";
  const startTime = Date.now();
  timerInterval=setInterval(()=>{
    const sec = Math.floor((Date.now()-startTime)/1000);
    document.getElementById("timeDisplay").textContent=Math.floor(sec/60)+":"+(sec%60<10?"0"+sec:sec%60);
    document.getElementById("progressDisplay").textContent="Ø§Ù„Ù…Ø±Ø­Ù„Ø© "+currentStage;
  },1000);
  showStage();
}

function showStage(){
  if(currentStage >= stages.length) {
    document.getElementById("questionText").textContent = "ğŸ¯ ØªÙ„Ù…ÙŠØ­ Ù…ÙƒØ§Ù† Ø§Ù„ÙƒÙ†Ø²: "+stages[stages.length-1].hints.easy;
    document.getElementById("optionsContainer").innerHTML="";
    codeContainer.style.display="none";
    document.getElementById("hintText").textContent="";
    return;
  }

  const stage = stages[currentStage];
  document.getElementById("questionText").textContent = stage.question;
  document.getElementById("hintText").textContent="";
  codeContainer.style.display="none";
  document.getElementById("codeInput").value="";

  const cont=document.getElementById("optionsContainer");
  cont.innerHTML="";
  stage.options.forEach((opt,i)=>{
    const btn=document.createElement("button");
    btn.className="optionBtn";
    btn.textContent=opt;
    btn.onclick=()=>{
      document.getElementById("hintText").textContent=(i+1===stage.answer?"âœ”ï¸ "+stage.hints.easy:"âŒ "+stage.hints.hard);
      codeContainer.style.display="block";
    };
    cont.appendChild(btn);
  });
}

document.getElementById("checkCodeBtn").onclick=()=>{
  const stage = stages[currentStage];
  const codeInput = document.getElementById("codeInput").value.trim();
  if(codeInput===stage.codes[playerTeam]){
    currentStage++;
    showStage();
  } else alert("Ø§Ù„ÙƒÙˆØ¯ Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©!");
};
</script>
</body>
</html>
