<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>فعالية شهد: إعداد البحث عن الكنز</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap&subset=arabic" rel="stylesheet">
<style>
body{
  font-family:"Baloo 2", cursive; 
  background:#eef6ff; 
  padding:15px; 
  text-align:center; 
  overflow-y: scroll; /* سكرول للصفحة */
  max-height: 100vh;
}
h1,h2{color:#2c4a6e;}
input,select,button{margin:5px; padding:8px; border-radius:8px; border:none; font-size:16px;}
button{background:#4a90e2; color:white; cursor:pointer;}
button:hover{transform:scale(1.05);}
#progressBoard div{padding:8px; margin:5px; font-weight:bold; color:white; border-radius:5px;}
</style>
</head>
<body>

<h1>إعداد لعبة البحث عن الكنز</h1>

<form id="gameSetupForm">
<label>عدد الفرق:</label>
<input type="number" id="teamCount" min="1" max="5" value="2"><br>
<div id="teamNamesContainer"></div>
<label>عدد المراحل:</label>
<input type="number" id="stageCount" min="1" max="10" value="3"><br>
<div id="stagesContainer"></div>
<button type="submit">حفظ الإعدادات</button>
</form>

<h2>لوحة متابعة الفرق</h2>
<div id="progressBoard"></div>

<button id="startAllBtn">ابدأ اللعب للجميع</button>
<button id="restartBtn">إعادة تشغيل اللعبة</button>
<button id="shareLinkBtn">مشاركة رابط اللعبة</button>

<script>
let stages = JSON.parse(localStorage.getItem("stages")) || [];
let teams = JSON.parse(localStorage.getItem("teams")) || [];
let colors = ["#4a90e2","#50b3d6","#70c1b3","#95d0b8","#7b68ee"];

const teamCountInput = document.getElementById("teamCount");
const stageCountInput = document.getElementById("stageCount");
const teamNamesContainer = document.getElementById("teamNamesContainer");
const stagesContainer = document.getElementById("stagesContainer");
const progressBoard = document.getElementById("progressBoard");
const form = document.getElementById("gameSetupForm");

function generateTeamFields(){
  const numTeams = parseInt(teamCountInput.value);
  teamNamesContainer.innerHTML = "";
  for(let t=0; t<numTeams; t++){
    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "اسم الفريق " + (t+1);
    input.id = "teamName"+t;
    input.value = "الفريق " + (t+1);
    teamNamesContainer.appendChild(input);
    teamNamesContainer.appendChild(document.createElement("br"));
  }
}
teamCountInput.addEventListener("input",generateTeamFields);

function generateStageFields(){
  const numStages = parseInt(stageCountInput.value);
  const numTeams = parseInt(teamCountInput.value) || 2;
  stagesContainer.innerHTML = "";
  for(let i=0;i<numStages;i++){
    let div = document.createElement("div");
    div.innerHTML = "<h3>المرحلة " + (i+1) + "</h3>" +
      "<label>السؤال:</label><input type='text' id='q"+i+"' value='سؤال "+(i+1)+"'><br>" +
      "<label>الخيار 1:</label><input type='text' id='opt1_"+i+"' value='خيار 1'><br>" +
      "<label>الخيار 2:</label><input type='text' id='opt2_"+i+"' value='خيار 2'><br>" +
      "<label>الخيار 3:</label><input type='text' id='opt3_"+i+"' value='خيار 3'><br>" +
      "<label>الإجابة الصحيحة (1-3):</label><input type='number' id='a"+i+"' min='1' max='3' value='1'><br>" +
      "<label>تلميح سهل:</label><input type='text' id='easy"+i+"' value='تلميح سهل "+(i+1)+"'><br>" +
      "<label>تلميح صعب:</label><input type='text' id='hard"+i+"' value='تلميح صعب "+(i+1)+"'><br>";
    for(let t=0; t<numTeams; t++){
      div.innerHTML += "<label>كود الفريق "+(t+1)+":</label><input type='text' id='code"+i+"_"+t+"' value='CODE"+i+"_"+t+"'><br>";
    }
    stagesContainer.appendChild(div);
  }
}
stageCountInput.addEventListener("input",generateStageFields);

form.addEventListener("submit",function(e){
  e.preventDefault();
  const numTeams = parseInt(teamCountInput.value);
  const numStages = parseInt(stageCountInput.value);
  teams = [];
  for(let t=0; t<numTeams; t++){
    teams.push(document.getElementById("teamName"+t).value);
  }
  stages = [];
  for(let i=0;i<numStages;i++){
    let stage = {
      question: document.getElementById("q"+i).value,
      options:[
        document.getElementById("opt1_"+i).value,
        document.getElementById("opt2_"+i).value,
        document.getElementById("opt3_"+i).value
      ],
      answer: parseInt(document.getElementById("a"+i).value),
      hints:{
        easy: document.getElementById("easy"+i).value,
        hard: document.getElementById("hard"+i).value
      },
      codes:{}
    };
    for(let t=0; t<numTeams; t++){
      stage.codes[teams[t]] = document.getElementById("code"+i+"_"+t).value;
    }
    stages.push(stage);
  }
  localStorage.setItem("teams",JSON.stringify(teams));
  localStorage.setItem("stages",JSON.stringify(stages));
  localStorage.setItem("gameStarted","no");
  localStorage.setItem("startTime",null);
  alert("تم حفظ كل المراحل وأسماء الفرق!");
  renderProgressBoard();
});

function renderProgressBoard(){
  progressBoard.innerHTML = "";
  teams.forEach(function(team,i){
    let div = document.createElement("div");
    div.id = "progress-"+team;
    div.style.backgroundColor = colors[i%colors.length];
    let savedStage = parseInt(localStorage.getItem("stage-"+team)) || 0;
    let savedTime = parseInt(localStorage.getItem("time-"+team)) || 0;
    div.textContent = team + ": المرحلة "+savedStage+" | الوقت "+Math.floor(savedTime/60)+":"+((savedTime%60<10)?"0"+savedTime%60:savedTime%60);
    progressBoard.appendChild(div);
  });
}

document.getElementById("startAllBtn").addEventListener("click",function(){
  localStorage.setItem("gameStarted","yes");
  localStorage.setItem("startTime",Date.now());
  alert("تم بدء اللعبة لكل الفرق!");
});

document.getElementById("restartBtn").addEventListener("click",function(){
  localStorage.clear();
  location.reload();
});

// زر مشاركة رابط اللعبة مع رابط نسبي
document.getElementById("shareLinkBtn").addEventListener("click",function(){
  let link = "player.html";  // رابط نسبي
  navigator.clipboard.writeText(link);
  alert("تم نسخ رابط اللعبة: "+link);
});

setInterval(renderProgressBoard,1000);
generateTeamFields();
generateStageFields();
renderProgressBoard();
</script>

</body>
</html>
